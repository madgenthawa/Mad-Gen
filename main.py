import streamlit as st
import google.generativeai as genai
import requests

# --- API SETUP ---
try:
    API_KEY = st.secrets["GEMINI_API_KEY"]
    genai.configure(api_key=API_KEY)
    # Model-ai FLASH-ku mathiyachu for speed
    model = genai.GenerativeModel('gemini-1.5-flash') 
except Exception as e:
    st.error(f"Maddy, API Key-la edho issue: {e}")

# --- APP CONFIG ---
st.set_page_config(page_title="Mad Gen AI", page_icon="ðŸŽ¨", layout="wide")

st.markdown("""
    <style>
    .stApp { background: linear-gradient(to right, #1e1e2f, #232235); color: white; }
    .stButton>button { border-radius: 20px; background: #FF4B4B; font-weight: bold; color: white; }
    </style>
    """, unsafe_allow_html=True)

st.title("ðŸ”¥ Mad Gen: Pro Edition")

col1, col2 = st.columns([1, 1])

with col1:
    user_input = st.text_area("Enna creative venum?", placeholder="Eg: Pongal Holiday poster...")
    style_type = st.select_slider("Quality Style:", options=["Minimalist", "High-End Professional", "Cinematic 8K", "Hyper-Realistic"])
    
    if st.button("Mad Gen, Magic Pannu! âœ¨"):
        if user_input:
            with st.spinner("Mad Gen is thinking..."):
                try:
                    # SAFETY SETTINGS: Block pannama irukka indha logic mukkiyam
                    safety_settings = [
                        {"category": "HARM_CATEGORY_HARASSMENT", "threshold": "BLOCK_NONE"},
                        {"category": "HARM_CATEGORY_HATE_SPEECH", "threshold": "BLOCK_NONE"},
                        {"category": "HARM_CATEGORY_SEXUALLY_EXPLICIT", "threshold": "BLOCK_NONE"},
                        {"category": "HARM_CATEGORY_DANGEROUS_CONTENT", "threshold": "BLOCK_NONE"},
                    ]
                    
                    prompt = f"Create a short catchy Tamil marketing tagline and 3 hashtags for: {user_input}"
                    # Content generation with safety disabled
                    response = model.generate_content(prompt, safety_settings=safety_settings)
                    
                    if response.text:
                        st.session_state['ai_text'] = response.text
                        # High quality Image Generation using Pollinations
                        st.session_state['img_url'] = f"https://pollinations.ai/p/{user_input.replace(' ', '%20')}?width=1080&height=1080&seed=99&model=flux"
                        st.session_state['generated'] = True
                except Exception as ai_err:
                    st.error(f"Error: {ai_err}. Maddy, API Key correct-ah irukkannu oru thadava check pannunga!")
        else:
            st.warning("Input kudunga Maddy!")

with col2:
    if 'generated' in st.session_state:
        st.subheader("ðŸš€ Mad Gen Result")
        st.success(st.session_state['ai_text'])
        st.image(st.session_state['img_url'], caption="Generated by Mad Gen")
        
        # Download Logic
        try:
            img_data = requests.get(st.session_state['img_url']).content
            st.download_button(label="ðŸ“¥ Download Image", data=img_data, file_name="mad_gen_poster.png", mime="image/png")
        except:
            st.write("Image-ai long press panni save pannunga!")

st.divider()
st.caption("Mad Gen AI | Safety Blocks Disabled âœ…")
