import streamlit as st
import requests
import time

# --- APP CONFIG ---
st.set_page_config(page_title="Mad Gen AI: Pro Edition", page_icon="üî•", layout="wide")

# Professional UI Styling
st.markdown("""
<style>
    .stApp { background: #0e1117; color: white; }
    .stButton>button { 
        background: linear-gradient(45deg, #FF4B2B, #FF416C); 
        color: white; border-radius: 20px; font-weight: bold; border: none; height: 3.5em; width: 100%;
    }
    .stDownloadButton>button {
        background: #28a745; color: white; border-radius: 20px; width: 100%;
    }
</style>
""", unsafe_allow_html=True)

st.title("üî• MAD GEN: PRO GENERATOR")
st.write("Maddy, this version is built for stability and high-quality downloads.")

col1, col2 = st.columns([1, 1])

with col1:
    st.subheader("üí° Your Idea")
    user_input = st.text_area("Describe your poster or wallpaper (e.g., 8k Roman Reigns, LIC Loan Poster):")
    
    if st.button("Generate Magic ‚ú®"):
        if user_input:
            with st.spinner("Mad Gen is building your image..."):
                # Using a unique seed to force a fresh, high-quality image every time
                seed = int(time.time())
                prompt = f"{user_input}, professional marketing poster, 8k resolution, highly detailed"
                img_url = f"https://pollinations.ai/p/{prompt.replace(' ', '%20')}?width=1024&height=1024&seed={seed}&model=flux"
                
                try:
                    # We fetch the data first to make sure it's valid
                    response = requests.get(img_url, timeout=30)
                    if response.status_code == 200 and len(response.content) > 10000:
                        st.session_state['img_data'] = response.content
                        st.session_state['img_url'] = img_url
                        st.session_state['generated'] = True
                    else:
                        st.error("Image not ready yet. Please click the button again in 5 seconds!")
                except Exception as e:
                    st.error(f"Connection error: {e}")
        else:
            st.warning("Please enter a description, Maddy!")

with col2:
    st.subheader("üñºÔ∏è Preview & Download")
    if 'generated' in st.session_state:
        # Displaying via URL prevents the 'UnidentifiedImageError'
        st.image(st.session_state['img_url'], caption="Generated by Mad Gen")
        
        # This button uses the RAW DATA we saved, ensuring a full-sized file
        st.download_button(
            label="üì• DOWNLOAD HD IMAGE",
            data=st.session_state['img_data'],
            file_name=f"mad_gen_{int(time.time())}.png",
            mime="image/png"
        )
